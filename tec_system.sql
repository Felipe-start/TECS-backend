DROP DATABASE IF EXISTS sistema_tec;
CREATE DATABASE sistema_tec;
USE sistema_tec;
CREATE TABLE IF NOT EXISTS users (id INT PRIMARY KEY AUTO_INCREMENT, username VARCHAR(100) NOT NULL, email VARCHAR(150) UNIQUE NOT NULL, password VARCHAR(255) NOT NULL, role ENUM('admin','user') DEFAULT 'user', nombre_completo VARCHAR(200), telefono VARCHAR(20), institucion VARCHAR(200), avatar TEXT, numero_trabajador VARCHAR(50), is_active TINYINT(1) DEFAULT 1, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, INDEX idx_email(email), INDEX idx_role(role), INDEX idx_active(is_active)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS institutions (id INT PRIMARY KEY AUTO_INCREMENT, user_id INT NOT NULL, nombre VARCHAR(200) NOT NULL, clave_cct VARCHAR(50) UNIQUE NOT NULL, telefono VARCHAR(20), extension VARCHAR(10), correo VARCHAR(150), nombre_representante VARCHAR(200), puesto_representante VARCHAR(100), direccion TEXT, logo TEXT, estado ENUM('active','inactive') DEFAULT 'active', created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, INDEX idx_user_id(user_id), INDEX idx_clave_cct(clave_cct), INDEX idx_estado(estado)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS careers (id INT PRIMARY KEY AUTO_INCREMENT, user_id INT NOT NULL, nombre VARCHAR(200) NOT NULL, numero_carrera VARCHAR(50) UNIQUE NOT NULL, cantidad_alumnos INT DEFAULT 0, duracion_semestres INT DEFAULT 8, modalidad ENUM('Escolarizada','Mixta','Virtual') DEFAULT 'Escolarizada', turno ENUM('Matutino','Vespertino','Nocturno','Mixto') DEFAULT 'Matutino', fecha_registro DATE, descripcion TEXT, activa TINYINT(1) DEFAULT 1, poblacion_esperada INT DEFAULT 0, poblacion_real INT DEFAULT 0, logo TEXT, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, INDEX idx_user_id(user_id), INDEX idx_numero_carrera(numero_carrera), INDEX idx_activa(activa)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS institution_careers (id INT PRIMARY KEY AUTO_INCREMENT, institution_id INT NOT NULL, career_id INT NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (institution_id) REFERENCES institutions(id) ON DELETE CASCADE, FOREIGN KEY (career_id) REFERENCES careers(id) ON DELETE CASCADE, UNIQUE KEY unique_institution_career(institution_id, career_id), INDEX idx_institution_id(institution_id), INDEX idx_career_id(career_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
INSERT INTO users (username,email,password,role,nombre_completo,telefono,institucion,numero_trabajador) VALUES ('admin','admin@tec.com','1234','admin','Administrador del Sistema','555-1234','Tecnológico Nacional','EMP001'), ('user','user@tec.com','1234','user','Usuario de Prueba','555-5678','TEC Campus Centro',NULL);
INSERT INTO institutions (user_id,nombre,clave_cct,telefono,correo,nombre_representante,puesto_representante,direccion,estado) VALUES (1,'Tecnológico Nacional de México','CCT001','555-1000','contacto@tecnm.mx','Dr. Juan Pérez','Director General','Av. Universidad 1000, CDMX','active'), (2,'TEC Campus Centro','CCT002','555-2000','info@teccentro.edu.mx','Ing. María García','Directora','Calle Central 200, Centro','active'), (1,'TEC Campus Norte','CCT003','555-3000','contacto@tecnorte.edu.mx','Lic. Roberto Sánchez','Director','Blvd. Norte 300, Zona Industrial','active');
INSERT INTO careers (user_id,nombre,numero_carrera,cantidad_alumnos,duracion_semestres,modalidad,turno,fecha_registro,descripcion,activa) VALUES (1,'Ingeniería en Sistemas Computacionales','ISC-001',150,9,'Escolarizada','Matutino','2024-01-15','Carrera enfocada en desarrollo de software y redes',1), (1,'Ingeniería Industrial','IND-002',120,9,'Escolarizada','Matutino','2024-01-15','Optimización de procesos industriales',1), (2,'Licenciatura en Administración','LAD-003',100,8,'Mixta','Vespertino','2024-01-15','Gestión empresarial y administrativa',1), (2,'Ingeniería en Mecatrónica','IME-004',80,10,'Escolarizada','Matutino','2024-01-15','Integración de mecánica, electrónica y computación',1);
INSERT INTO institution_careers (institution_id,career_id) VALUES (1,1),(1,2),(1,3),(2,1),(2,4),(3,2),(3,3);
DELIMITER //;
CREATE PROCEDURE GetSystemStatistics() BEGIN SELECT (SELECT COUNT(*) FROM users) AS total_users, (SELECT COUNT(*) FROM users WHERE role='admin') AS admin_users, (SELECT COUNT(*) FROM users WHERE role='user') AS normal_users, (SELECT COUNT(*) FROM users WHERE is_active=1) AS active_users; SELECT (SELECT COUNT(*) FROM institutions) AS total_institutions, (SELECT COUNT(*) FROM institutions WHERE estado='active') AS active_institutions; SELECT (SELECT COUNT(*) FROM careers) AS total_careers, (SELECT COUNT(*) FROM careers WHERE activa=1) AS active_careers, (SELECT SUM(cantidad_alumnos) FROM careers) AS total_alumnos; END //;
DELIMITER ;
CREATE VIEW vw_institutions_with_careers AS SELECT i.id, i.nombre AS institucion, i.clave_cct, i.estado, u.username AS propietario, COUNT(ic.career_id) AS total_carreras, GROUP_CONCAT(c.nombre SEPARATOR ', ') AS carreras FROM institutions i LEFT JOIN users u ON i.user_id=u.id LEFT JOIN institution_careers ic ON i.id=ic.institution_id LEFT JOIN careers c ON ic.career_id=c.id GROUP BY i.id, i.nombre, i.clave_cct, i.estado, u.username;
CREATE VIEW vw_careers_by_user AS SELECT c.id, c.nombre AS carrera, c.numero_carrera, c.modalidad, c.turno, c.activa, u.username AS propietario, u.email FROM careers c LEFT JOIN users u ON c.user_id=u.id ORDER BY c.created_at DESC;
DELIMITER //;
CREATE TRIGGER tr_update_institution_timestamp BEFORE UPDATE ON institutions FOR EACH ROW BEGIN SET NEW.updated_at=CURRENT_TIMESTAMP; END //;
CREATE TRIGGER tr_update_career_timestamp BEFORE UPDATE ON careers FOR EACH ROW BEGIN SET NEW.updated_at=CURRENT_TIMESTAMP; END //;
CREATE TRIGGER tr_update_user_timestamp BEFORE UPDATE ON users FOR EACH ROW BEGIN SET NEW.updated_at=CURRENT_TIMESTAMP; END //;
CREATE TRIGGER tr_check_user_institution_limit BEFORE INSERT ON institutions FOR EACH ROW BEGIN DECLARE user_role VARCHAR(10); DECLARE institution_count INT; SELECT role INTO user_role FROM users WHERE id=NEW.user_id; IF user_role='user' THEN SELECT COUNT(*) INTO institution_count FROM institutions WHERE user_id=NEW.user_id; IF institution_count>=1 THEN SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='Los usuarios normales solo pueden tener una institución'; END IF; END IF; END //;
DELIMITER ;
CREATE INDEX idx_institutions_user_estado ON institutions(user_id,estado);
CREATE INDEX idx_careers_user_activa ON careers(user_id,activa);
CREATE INDEX idx_users_created ON users(created_at);
CREATE INDEX idx_institutions_created ON institutions(created_at);
CREATE INDEX idx_careers_created ON careers(created_at);
SELECT 'Base de datos creada exitosamente' AS mensaje;
